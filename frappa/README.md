Synchronization for FRAPPA
==========================

Multi-camera
------------
To calibrate more than one camera to use an objective for Targeted Illumination,
mutiple Objective Magnifications need to be created.  Thus a microscope with
a single "100x Apo TIRF" Objective Magnification would need to be replaced by
camera-named magnifications like "100x Confocal" and "100x Widefield"

Unfortunately having multiple magnifications for same objective means Metamorph
will no longer synchronize it's Magnification dropdown menu to match the automated
microscope's position.  In practise this requires you to change both, the "Coordinate 
system setting" in the Targeted Illumination window as well as the Magnification
dropdown!

### Solution
Set the Magnification and then set the Coordinate system to the Manification
as follows:

1.  Detect the objective in use with `_new_var_objective.jnl` by linking this
    journal to your camera selection button.
2.  Have said camera selection button update the Magnification dropdown
    by updating the builtin `Device.Magnification.Setting`
3.  Finally `_mda_pulse.jnl` action in the protocol will be able to override the
    "Coordinate system setting" with Device.Magnification.Setting

Rear port FRAPPA systems
-----------------------
<img src="https://github.com/downloads/omsai/journals/ringing_bleach.PNG"
 alt="ringing artifact" title="40us dwell time, confocal image" align="right" />

Metamorph's asynchronous acquisition projects the vibration "ringing" artifacts
from the motorized microscope epi laser cube onto the bleach region.  If the
laser dwell time is long enough, instead of ringing only thin streaks will
appear above and below one edge of the bleach region.

### Solution
Use `_delay_for_illumination.jnl` to insert a short delay for each FRAPPA channel
to surpress this "ringing".  Add it to the " Run journal when toggling active shutter"
of each FRAPPA illumination.<!-- content below automatically generated by C:\MM\app\mmproc\journals\doc_jnl.py -->
Source Code
-----------
clear_all_regions.jnl:
```python
Clear_All_Regions(ClearRegionsJNL.clearImage = m	1 5 9 0 1 -1 -1 21 Targeted Illumination)
```

mda_pulse.jnl:
```python
'''
Pulse action inside MDA
'''

# Select the last active image window with the ROI
Run_Journal(50 C:\MM\app\mmproc\journals\frappa\_load_regions.jnl)

# Pulse, pulling coordinate setting from current magnification selection
Targeted_Illumination(Illumination setting = 10 FRAPPA 488,
                      Imaging Illumination setting = 12 Confocal 488,
                      Device.Magnification.Setting = 13 100x Confocal,
                      Position: setting (1=image coords, 2=center of active region, 3=all region centers) = 3,
                      Position: image coordinate X = 1000,
                      Position: image coordinate Y = 1000,
                      Number of laser pulses = 1,
                      Attenuator plate: % transmission = 5,
                      Mask Exposure Duration [ms] = 0.04)
```

save_regions.JNL:
```python
'''
Save all regions to file "1.rgn"
'''
Save_Regions("C:\MM\app\mmproc\journals\frappa_temp.rgn" = 31 C:\MM\app\mmproc\journals\1.rgn,
             m	1 5 9 0 1 -1 -1 8 Untitled )
```

_delay_for_illumination.jnl:
```python
'''
Delay for toggling FRAPPA illuminations.  Rear port FRAPPA setup doesn't give
enough time for the epi cube to settle before bleach causing [wave distortions
to the bleach spot](http://imgur.com/XVAmn)
'''
Delay(10,
      1)
```

_load_regions.jnl:
```python
'''
New Journal
'''
Run_Journal(54 C:\MM\app\mmproc\journals\frappa\clear_all_regions.jnl)
Load_Regions("C:\MM\app\mmproc\journals\frappa_temp.rgn" = 51 C:\MM\app\mmproc\journals\Mosaic Optogenetics\1.rgn,
             m	1 5 9 0 1 -1 -1 8 Untitled )
```

_new_var_objective.jnl:
```python
'''
Creates `objective` variable by microscope objective label. e.g.: create `100`
from "Apo TIRF 100x / 1.49 NA". In your camera selection journal, 1) run this
journal and 2) set `Device.Magnification.Setting` to e.g. (objective_STR + "
Confocal") depending on your camera
'''

# Assume `/` separates magnification from NA
string_split_position = INSTR(Component.Ti_Objective.PositionLabel,"/")

# Extract 3 digit number before `/`
objective_STR = MID(Component.Ti_Objective.PositionLabel, string_split_position - 5, 3)
objective = VAL(objective_STR)
# Need this to remove any leading space
objective_STR = STR(objective)
```
